<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Oh Procd</title>

    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 20px;
            background: #fafafa;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th,
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #e5e5e5;
            text-align: left;
            vertical-align: middle;
        }

        th {
            background: #f5f5f5;
            font-weight: 600;
            font-size: 14px;
        }

        tr:hover {
            background: #f9f9f9;
        }

        td code {
            white-space: nowrap;
            max-width: 420px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
            font-family: monospace;
            font-size: 13px;
        }

        button {
            padding: 6px 10px;
            font-size: 13px;
            cursor: pointer;
            border-radius: 4px;
            border: 1px solid #ccc;
            background: #fff;
        }

        button:hover {
            background: #eee;
        }

        button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* ---- state colors ---- */
        .state-running {
            color: #16a34a;
            font-weight: 600;
        }

        .state-err {
            color: #dc2626;
        }

        .footer {
            margin-top: 12px;
            font-size: 12px;
            color: #666;
        }

        label {
            color: gray;
            font-size: 11px;
        }

        .child_pid {
            color: gray;
            font-size: 11px;
            margin-top: 3px;
        }
    </style>
</head>

<body>

    <h1>Oh Procd</h1>
    <div style="float: right;padding-right: 30px;">
        <span><a href="/api/logs">logs</a></span>
    </div>
    <table>
        <caption style="padding: 12px;font-size: 18px;background: #f5f7fa;border-bottom: 1px solid #e6e8eb;">Process List</caption>
        <thead>
            <tr>
                <th>No.</th>
                <th>Name</th>
                <th>PID</th>
                <th>State</th>
                <th>Command</th>
                <th>Memory</th>
                <th>Time</th>
                <th>Start Count</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="process-table"></tbody>
    </table>

    <table style="margin-top: 50px; width: auto;">
        <caption>System Info</caption>
        <thead>
            <tr>
                <th style="text-align: center;">Name</th>
                <th style="text-align: center;">Value</th>
            </tr>
        </thead>
        <tbody id="system-info"></tbody>
    </table>


    <div class="footer">
        Auto refresh every 3 seconds
    </div>

    <script>
        function formatCommand(cmd) {
            if (!cmd || !cmd.cmd) return "-";
            const args = (cmd.args || []).join(" ");
            return cmd.cmd + (args ? " " + args : "");
        }

        function stateToClass(state) {
            if (state && state === "Running") return "state-running";
            return "state-err";
        }

        function canRestart(state) {
            return state !== "Starting";
        }

        async function loadProcesses() {
            try {
                const res = await fetch("/api/processes");
                const obj = await res.json();
                const processes = obj.data;

                const sysInfo = document.getElementById("system-info");
                let sysInfoCode = ""
                Object.entries(obj.server).forEach(([key, value]) => {
                    sysInfoCode += `<tr><td style='text-align:right'>${key} :</td><td>${value}</td></tr>`;
                });
                sysInfo.innerHTML = sysInfoCode;

                const tbody = document.getElementById("process-table");
                tbody.innerHTML = "";

                processes.forEach((p, index) => {
                    const tr = document.createElement("tr");

                    const cmdText = formatCommand(p.cmd);
                    const stateClass = stateToClass(p.state);

                    const stateStr = JSON.stringify(p.state).replace(/"/g, "");
                    let code = `<td>${index}</td><td>`;

                    if (p.web_address !== "") {
                        code += `<a href='${p.web_address}' target='_blank'>${p.name}</a>`;
                    } else {
                        code += `${p.name}`;
                    }


                    code += `</td>`;
                    code += `<td><div>${p.pid || "-"}</div><div class="child_pid">${p.child_pids || ""}</div></td>`;
                    code += `<td class="${stateClass}">${stateStr}</td>
                <td title="${cmdText}">
                    <code>${cmdText}</code>
                </td>
                <td>`;

                    if (p.memory_limit > 0) {
                        code += `<div style="white-space: nowrap"><label>Limit:</label> ${p.memory_limit} MB</div>`;
                    }

                    if (p.memory_used != "") {
                        code += `<div style="white-space: nowrap"><label>Used:</label> ${p.memory_used || "-"}</div>`;
                    }

                    code += `</td>
                <td style="white-space: nowrap">`;

                    code += `<div><label class='gray'>Start: </label>${p.start_time || "-"}</div>`;
                    if (p.exit_time) {
                        code += `<div><label class='gray'>&nbsp; Exit: </label>${p.exit_time || "-"}</div>`;
                    }

                    code += `</td>

                <td>${p.start_count}</td>
                <td>`


                    if (p.state === "Running") {
                        code += `<button onclick="restartProcess('${p.name}')" > Restart </button>`
                        code += `<button onclick="killProcess('${p.name}')" > Kill </button>`
                    } else if (p.state !== "Running") {
                        code += `<button onclick="startProcess('${p.name}')" > Start </button>`
                    }

                    code += "</td>"

                    tr.innerHTML = code;

                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error("loadProcesses failed:", err);
            }
        }

        async function restartProcess(name) {
            if (!confirm(`Restart process "${name}"?`)) {
                return;
            }

            try {
                await fetch(`/api/process/${name}/restart`, {
                    method: "POST"
                });
                loadProcesses();
            } catch (err) {
                alert("Restart failed: ${err.message || err}");
            }
        }

        async function killProcess(name) {
            if (!confirm(`Kill process "${name}"?`)) {
                return;
            }

            try {
                await fetch(`/api/process/${name}/kill`, {
                    method: "POST"
                });
                loadProcesses();
            } catch (err) {
                alert("Kill failed: ${err.message || err}");
            }
        }

        async function startProcess(name) {
            if (!confirm(`Start process "${name}"?`)) {
                return;
            }

            try {
                await fetch(`/api/process/${name}/start`, {
                    method: "POST"
                });
                loadProcesses();
            } catch (err) {
                alert("Start failed: ${err.message || err}");
            }
        }

        // initial load
        loadProcesses();

        // auto refresh
        setInterval(loadProcesses, 3000);
    </script>

</body>

</html>